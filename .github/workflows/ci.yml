name: CI

on: [push, pull_request]
jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          autotools
          make
          git
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-gcc
    - uses: actions/checkout@v4
    - shell: msys2 {0}
      run: |
        make test
        sh ./test/test.sh
  build-macosx:
    runs-on: macos-latest
    steps:
    - name: Install dependencies
      run: |
        brew update
        brew install openssl autoconf
        brew link openssl --force
        pkg-config --cflags openssl
        pkg-config --libs openssl
    - uses: actions/checkout@v4
    - name: make
      run: |
        make test
        sh ./test/test.sh
  build-linux:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=5
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev autoconf
    - uses: actions/checkout@v4
    - name: make
      run: |
        make test
        sh ./test/test.sh

  build-linux-sql:
    name: build-linux-sql
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: mysql-8.0
            db_image: mysql:8.0
            options: >-
              --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=5
          - name: mariadb-10.6
            db_image: mariadb:10.6
            options: >-
              --health-cmd="mysqladmin ping -uroot -proot --silent" --health-interval=10s --health-timeout=5s --health-retries=5
    services:
      db:
        image: ${{ matrix.db_image }}
        env:
          MYSQL_ROOT_PASSWORD: root
          MARIADB_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: ${{ matrix.options }}
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev autoconf
    - uses: actions/checkout@v4
    - name: DB-focused tests
      run: |
        make test
        ./silly test/test.lua --set=testmysql
